<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кредитен посредник — тест</title>
  <style>
    body{font:16px/1.5 system-ui;margin:40px;max-width:720px}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:8px;width:100%}
    button{margin-top:16px;background:#0ea5e9;color:#fff;border:none;cursor:pointer}
    .ok{color:#16a34a;margin-top:10px}
    .err{color:#dc2626;margin-top:10px}
  </style>
</head>
<body>
  <h1>Испрати тест барање за кредит</h1>
  <p>Ова е наједноставна верзија за тест. Ги праќа податоците до <code>/api/leads</code> и стига e-mail со CSV.</p>

  <form id="f" onsubmit="sendLead(event)">
    <label>Име</label>
    <input id="first_name" required placeholder="Иван">

    <label>Презиме</label>
    <input id="last_name" required placeholder="Иванов">

    <label>Телефон (+3897… или 07…)</label>
    <input id="phone" required placeholder="+3897XXXXXXX">

    <label>Потребен износ (МКД)</label>
    <input id="amount" type="number" min="1000" step="500" required value="100000">

    <label>Посакувана рата (МКД)</label>
    <input id="installment" type="number" min="500" step="100" required value="5000">

    <label>Избери партнер</label>
    <select id="partner">
      <option>Тест 1 – финансиско друштво</option>
      <option>Тест 2 – финансиско друштво</option>
      <option>Тест 3 – финансиско друштво</option>
      <option>Тест 4 – финансиско друштво</option>
      <option>Тест 5 – финансиско друштво</option>
      <option>Тест 6 – финансиско друштво</option>
      <option>Тест 7 – финансиско друштво</option>
      <option>Тест 8 – финансиско друштво</option>
      <option>Тест 9 – финансиско друштво</option>
      <option>Тест 10 – финансиско друштво</option>
    </select>

    <button type="submit">Испрати</button>
    <div id="ok" class="ok" style="display:none">✔️ Испратено.</div>
    <div id="err" class="err" style="display:none">⚠️ Грешка при испраќање.</div>
  </form>

  <script>
  const ENDPOINT = "/api/leads";

  // Мапа: „Име на партнер → email“ (placeholder адреси)
  const PARTNER_EMAILS = {
    "Тест 1 – финансиско друштво":  "test1@partners.example",
    "Тест 2 – финансиско друштво":  "test2@partners.example",
    "Тест 3 – финансиско друштво":  "test3@partners.example",
    "Тест 4 – финансиско друштво":  "test4@partners.example",
    "Тест 5 – финансиско друштво":  "test5@partners.example",
    "Тест 6 – финансиско друштво":  "test6@partners.example",
    "Тест 7 – финансиско друштво":  "test7@partners.example",
    "Тест 8 – финансиско друштво":  "test8@partners.example",
    "Тест 9 – финансиско друштво":  "test9@partners.example",
    "Тест 10 – финансиско друштво": "test10@partners.example"
  };

  // default fallback — ако не се пронајде партнер или е празно
  const DEFAULT_PARTNER_EMAIL = "ideamkkredit@yahoo.com";

  function toE164MK(raw){
    const d = String(raw).replace(/\D+/g,'');
    if(!d) return "";
    if(d.startsWith("389")) return "+"+d;
    if(d.startsWith("0")) return "+389"+d.slice(1);
    if(d.startsWith("7")) return "+389"+d;
    return "+"+d;
  }

  async function sendLead(e){
  e.preventDefault();
  ok.style.display = err.style.display = "none";
  try {
    const selectedPartner = f.partner.value;
    const partnerEmail = PARTNER_EMAILS[selectedPartner] || DEFAULT_PARTNER_EMAIL;
    const consentChecked = document.getElementById("consent")?.checked ?? true;

    const payload = {
      full_name: f.first_name.value.trim() + " " + f.last_name.value.trim(),
      first_name: f.first_name.value.trim(),
      last_name: f.last_name.value.trim(),
      phone_e164: toE164MK(f.phone.value.trim()),
      requested_amount_mkd: Number(f.amount.value),
      target_installment_mkd: Number(f.installment.value),
      partner: selectedPartner,
      partner_id: selectedPartner.split(" ")[1] || "test",
      partner_email: partnerEmail,
      consent: consentChecked,
      consent_timestamp: new Date().toISOString(),
      source: "landing-min"
    };

    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    ok.style.display = "block";
  } catch (e2) {
    console.error(e2);
    err.style.display = "block";
  }
}

  const f = document.getElementById("f");
  const ok = document.getElementById("ok");
  const err = document.getElementById("err");
</script>

</body>
</html>
